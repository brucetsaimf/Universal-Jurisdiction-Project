---
title: "UJ Plots"
output: html_document
---

```{r}
suppressMessages(library(readxl))
suppressMessages(library(igraph))
suppressMessages(library(tidyverse))
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(ggraph))
suppressMessages(library(maps))
suppressMessages(library(lubridate))
suppressMessages(library(janitor))
suppressMessages(library(tibble))
```

# Load Data

```{r}
raw_data = read_xlsx("Langer-Eason Database Clean.xlsx", sheet = 1)
raw_data$`prosecuting state`[32] = "Germany"
```

# Sort By Prosecuting/Defendant Nationality State

```{r}
states = raw_data[,c(4:5,14,19,26)]

# Recode States
states[states$`def nationality state` == "Nazi","def nationality state"] = "Germany"
states[states$`def nationality state` == "Congo_Brazzaville","def nationality state"] = "Congo"
states[states$`def nationality state` == "Congo_DRC","def nationality state"] = "DRC"
states[states$`def nationality state` == "ISIS/Daesh","def nationality state"] = "Iraq" # Or Syria?
states[states$`def nationality state` == "The_Netherlands","def nationality state"] = "Netherlands"
states[states$`def nationality state` == "Former Yugoslavia","def nationality state"] = "Serbia"
states[states$`def nationality state` == "Former_Yugoslavia","def nationality state"] = "Serbia"
states$`def nationality state` = factor(states$`def nationality state`)
states_def = data.frame(summary(states$`def nationality state`))

states[states$`prosecuting state` == "New_Zealand","prosecuting state"] = "New Zealand"
states[states$`prosecuting state` == "The_Netherlands","prosecuting state"] = "Netherlands"
states$`prosecuting state` = factor(states$`prosecuting state`)
states_pros = data.frame(summary(states$`prosecuting state`))

colnames(states)[3] = "Case.Year"
```

# Cases by Year with LOESS smoother
## LOESS Plot
```{r}
case_by_year = data.frame(summarise(group_by(states, `Case.Year`), count = n()))
lw3 = loess(count ~. , data = case_by_year, span = 0.3)
lw5 = loess(count ~. , data = case_by_year, span = 0.5)
lw7 = loess(count ~. , data = case_by_year, span = 0.7)
smoothed3 = predict(lw3) 
smoothed5 = predict(lw5) 
smoothed7 = predict(lw7) 
plot(case_by_year$count, x=case_by_year$Case.Year, type="l", main="Loess Smoothing and Prediction for Cases by Year", xlab="Year", ylab="Counts")
lines(smoothed3, x=case_by_year$Case.Year, col="red")
lines(smoothed5, x=case_by_year$Case.Year, col="blue")
lines(smoothed7, x=case_by_year$Case.Year, col="green")
legend("topleft", legend=c("LOESS 0.3 Span", "LOESS 0.5 Span", "LOESS 0.7 Span"),
       col=c("red", "blue","green"), lty=1)
```

# Trials by Year with LOESS smoother

## Clean Trial Date Data

```{r}
states = data.frame(states)
states$Initial_Trial_Start_Date = factor(states$Initial_Trial_Start_Date)
#summary(states$Initial_Trial_Start_Date)

states_data_clean1 = filter(states, states$Initial_Trial_Start_Date == "1989 (approx)")
states_data_clean2 = filter(states, states$Initial_Trial_Start_Date == "1990 (approx)")
states_data_clean3 = filter(states, states$Initial_Trial_Start_Date == "1994 (approx)")
states_data_clean4 = filter(states, states$Initial_Trial_Start_Date == "2005")
states_data_clean5 = filter(states, states$Initial_Trial_Start_Date == "NA")
states_data_clean6 = filter(states, is.na(states$Initial_Trial_Start_Date))
states_data_clean7 = filter(states, !(states$Initial_Trial_Start_Date == "1989 (approx)"|
                                       states$Initial_Trial_Start_Date == "1990 (approx)" |
                                        states$Initial_Trial_Start_Date == "1994 (approx)" |
                                        states$Initial_Trial_Start_Date == "2005" |
                                        states$Initial_Trial_Start_Date == "NA" |
                                        is.na(states$Initial_Trial_Start_Date)))

states_data_clean1$TrialYear = 1989
states_data_clean2$TrialYear = 1990
states_data_clean3$TrialYear = 1994
states_data_clean4$TrialYear = 2005
states_data_clean5$TrialYear = NA
states_data_clean6$TrialYear = NA

states_data_clean7$Initial_Trial_Start_Date = excel_numeric_to_date(as.numeric(as.character(states_data_clean7$Initial_Trial_Start_Date)), date_system = "modern")    
states_data_clean7$TrialYear = as.numeric(substring(states_data_clean7$Initial_Trial_Start_Date,1,4))

states_data_clean7$Initial_Trial_Start_Date = as.character(states_data_clean7$Initial_Trial_Start_Date)

states_data = bind_rows(states_data_clean1,states_data_clean2,states_data_clean3,states_data_clean4,states_data_clean5,states_data_clean6,states_data_clean7)
```

## LOESS Plot

```{r}
trial_by_year = data.frame(summarise(group_by(states_data, `TrialYear`), count = n()))
trial_by_year = trial_by_year[!(is.na(trial_by_year$TrialYear)),]
lw3a = loess(count ~. , data = trial_by_year, span = 0.3)
lw5a = loess(count ~. , data = trial_by_year, span = 0.5)
lw7a = loess(count ~. , data = trial_by_year, span = 0.7)

smoothed3a = predict(lw3a) 
smoothed5a = predict(lw5a) 
smoothed7a = predict(lw7a) 
plot(trial_by_year$count, x=trial_by_year$TrialYear, type="l", main="Loess Smoothing and Prediction for Trials by Year", xlab="Year", ylab="Counts")
lines(smoothed3a, x=trial_by_year$TrialYear, col="red")
lines(smoothed5a, x=trial_by_year$TrialYear, col="blue")
lines(smoothed7a, x=trial_by_year$TrialYear, col="green")
legend("topleft", legend=c("LOESS 0.3 Span", "LOESS 0.5 Span", "LOESS 0.7 Span"),
       col=c("red", "blue","green"), lty=1)
```

# LOESS GGPLOT with 0.7 Span

## Cases GGPLOT
```{r}
case_by_year$loess = smoothed7

ggplot(case_by_year, aes(y=count, x=Case.Year)) +
  geom_bar(stat="identity") +
  geom_line(aes(x = Case.Year, y = loess)) +
  labs(title = "LOESS Overlay on Case Numbers", x = "Case Year", y = "Number of Cases") + 
  geom_text(aes(x = Case.Year, y = count + 10, label = count), color = "dark grey")

```

## Trials GGPLOT

```{r}
trial_by_year$loess = smoothed7a

ggplot(trial_by_year, aes(y=count, x=TrialYear)) +
  geom_bar(stat="identity") +
  geom_line(aes(x = TrialYear, y = loess)) +
  labs(title = "LOESS Overlay on Trial Numbers", x = "Trial Year", y = "Number of Trials") + 
  geom_text(aes(x = TrialYear, y = count + 0.2, label = count), color = "dark grey")
```


# Case/Trial State Tables

Put in rank order with country
Columns: 
- Country name
- Total cases  
- Year of first case
- No. Cases 1950-2000
- No. Case 2000-present
- Total trials
- Year of first trial
- No. trials 1950-2000
- No. trials 2000-present

```{r}
def_table = states_data %>% 
  group_by(`def.nationality.state`) %>% 
  summarise(`First Case` = min(`Case.Year`),
            `Total Cases` = sum(!is.na(Case.Year)),
            `Cases 1950 - 2000` = sum(!is.na(Case.Year) & Case.Year <= 2000),
            `Cases 2000 - Present` = sum(!is.na(Case.Year) & Case.Year > 2000),
            `First Trial` = suppressWarnings(min(`TrialYear`, na.rm=T)),
            `Total Trials` = sum(!(is.na(TrialYear))),
            `Trials 1950 - 2000` = sum(!is.na(TrialYear) & TrialYear <= 2000),
            `Trials 2000 - Present` = sum(!is.na(TrialYear) & TrialYear > 2000)) %>%
  mutate(`First Trial` = ifelse(is.infinite(`First Trial`), NA, `First Trial`))

def_table = arrange(def_table, desc(`Total Cases`))
def_table
write.csv(def_table,"Defending States Table.csv")

pro_table = states_data %>% 
  group_by(`prosecuting.state`) %>% 
  summarise(`First Case` = min(`Case.Year`),
            `Total Cases` = sum(!is.na(Case.Year)),
            `Cases 1950 - 2000` = sum(!is.na(Case.Year) & Case.Year <= 2000),
            `Cases 2000 - Present` = sum(!is.na(Case.Year) & Case.Year > 2000),
            `First Trial` = suppressWarnings(min(`TrialYear`, na.rm=T)),
            `Total Trials` = sum(!(is.na(TrialYear))),
            `Trials 1950 - 2000` = sum(!is.na(TrialYear) & TrialYear <= 2000),
            `Trials 2000 - Present` = sum(!is.na(TrialYear) & TrialYear > 2000)) %>%
  mutate(`First Trial` = ifelse(is.infinite(`First Trial`), NA, `First Trial`))

pro_table = arrange(pro_table, desc(`Total Cases`))
pro_table
write.csv(pro_table,"Prosecuting States Table.csv")
```
