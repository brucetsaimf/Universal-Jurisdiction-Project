---
title: "UJ Regressions Data Prep"
output: html_document
---

```{r}
suppressMessages(library(readxl))
suppressMessages(library(igraph))
suppressMessages(library(tidyverse))
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(ggraph))
suppressMessages(library(maps))
suppressMessages(library(lubridate))
suppressMessages(library(janitor))
suppressMessages(library(tibble))
suppressMessages(library(haven))
suppressMessages(library(jtools))
suppressMessages(library(huxtable))
suppressMessages(library(devtools))
suppressMessages(library(Zelig))
suppressMessages(library(psych))
suppressMessages(library(Hmisc))
suppressMessages(library(fts))
suppressMessages(library(zoo))
suppressMessages(library(runner))
suppressMessages(library(tibbletime))
suppressMessages(library(stargazer))
```

Note: Zelig is unavailable through CRAN. Run devtools::install_github('IQSS/Zelig') to install package.

# UJ Dataset Sort+Clean

```{r}
uj_raw = read_xlsx("Langer-Eason Database Clean.xlsx", sheet = 1)
uj_raw$`prosecuting state`[32] = "Germany"

uj_data = uj_raw[,c(3,4:5,10,14,17,19,26)]

uj_data = uj_data %>% rowwise() %>% mutate(nazi = ifelse(`def nationality state` == "Nazi", 1, 0))
uj_data = uj_data %>% rowwise() %>% mutate(fy = ifelse(`def nationality state` == "Former Yugoslavia" | 
                                                         `def nationality state` == "Former_Yugoslavia", 1, 0))
uj_data = uj_data %>% rowwise() %>% mutate(isis = ifelse(`def nationality state` == "ISIS/Daesh", 1, 0))
uj_data = uj_data %>% rowwise() %>% mutate(isjd = ifelse(grepl("Doe", defendant_name) == T, 1, 0))

# Recode States
uj_data[uj_data$`def nationality state` == "Nazi","def nationality state"] = "Germany"
uj_data[uj_data$`def nationality state` == "Congo_Brazzaville","def nationality state"] = "Congo"
uj_data[uj_data$`def nationality state` == "Congo_DRC","def nationality state"] = "Democratic Republic of the Congo"
uj_data[uj_data$`def nationality state` == "ISIS/Daesh","def nationality state"] = "Iraq" # Or Syria?
uj_data[uj_data$`def nationality state` == "The_Netherlands","def nationality state"] = "Netherlands"
uj_data[uj_data$`def nationality state` == "Former Yugoslavia","def nationality state"] = "Serbia" # Or Montenegro?
uj_data[uj_data$`def nationality state` == "Former_Yugoslavia","def nationality state"] = "Serbia" # Or Montenegro?

uj_data[uj_data$`prosecuting state` == "New_Zealand","prosecuting state"] = "New Zealand"
uj_data[uj_data$`prosecuting state` == "The_Netherlands","prosecuting state"] = "Netherlands"

uj_data = data.frame(uj_data)
uj_data$Initial_Trial_Start_Date = factor(uj_data$Initial_Trial_Start_Date)


states_data_clean1 = filter(uj_data, uj_data$Initial_Trial_Start_Date == "1989 (approx)")
states_data_clean2 = filter(uj_data, uj_data$Initial_Trial_Start_Date == "1990 (approx)")
states_data_clean3 = filter(uj_data, uj_data$Initial_Trial_Start_Date == "1994 (approx)")
states_data_clean4 = filter(uj_data, uj_data$Initial_Trial_Start_Date == "2005")
states_data_clean5 = filter(uj_data, uj_data$Initial_Trial_Start_Date == "NA")
states_data_clean6 = filter(uj_data, is.na(uj_data$Initial_Trial_Start_Date))
states_data_clean7 = filter(uj_data, !(uj_data$Initial_Trial_Start_Date == "1989 (approx)"|
                                       uj_data$Initial_Trial_Start_Date == "1990 (approx)" |
                                        uj_data$Initial_Trial_Start_Date == "1994 (approx)" |
                                        uj_data$Initial_Trial_Start_Date == "2005" |
                                        uj_data$Initial_Trial_Start_Date == "NA" |
                                        is.na(uj_data$Initial_Trial_Start_Date)))

states_data_clean1$TrialYear = 1989
states_data_clean2$TrialYear = 1990
states_data_clean3$TrialYear = 1994
states_data_clean4$TrialYear = 2005
states_data_clean5$TrialYear = NA
states_data_clean6$TrialYear = NA

states_data_clean7$Initial_Trial_Start_Date = excel_numeric_to_date(as.numeric(as.character(states_data_clean7$Initial_Trial_Start_Date)), date_system = "modern")    
states_data_clean7$TrialYear = as.numeric(substring(states_data_clean7$Initial_Trial_Start_Date,1,4))

states_data_clean7$Initial_Trial_Start_Date = as.character(states_data_clean7$Initial_Trial_Start_Date)

uj_data = bind_rows(states_data_clean1,states_data_clean2,states_data_clean3,states_data_clean4,states_data_clean5,states_data_clean6,states_data_clean7)

uj_data$formal.proceedings.initiated.date..formally.charged.or.indicted. = as.numeric(substring(excel_numeric_to_date(as.numeric(as.character(uj_data$formal.proceedings.initiated.date..formally.charged.or.indicted.)), date_system = "modern"),1,4))

colnames(uj_data)[6] = "InvestYear"
```

# Replication Dataset

```{r}
replication_data = read.csv("dyadic_data.csv")
```

# Leblang Dataset

```{r}
leblang_data = read_dta("updated_Migration_Data_08Jan15.dta")
```

# UNHCR Dataset

```{r}
unhcr_data = read.csv("imputed.csv")
```

# CCodes

```{r}
ccode = read_excel("COW-ISO-IMF country code lists.xlsx")
ccode = ccode[,c(2:3)]
ccode = distinct(ccode, CCode, .keep_all = T)
```

# UJ Data Aggregates by Country/Year

```{r}
def_table = uj_data %>% 
  group_by(`def.nationality.state`) %>% 
  summarise(`First Case` = min(`Case.Year`),
            `Total Cases` = sum(!is.na(Case.Year)),
            `Cases 1950 - 2000` = sum(!is.na(Case.Year) & Case.Year <= 2000),
            `Cases 2000 - Present` = sum(!is.na(Case.Year) & Case.Year > 2000),
            `First Trial` = suppressWarnings(min(`TrialYear`, na.rm=T)),
            `Total Trials` = sum(!(is.na(TrialYear))),
            `Trials 1950 - 2000` = sum(!is.na(TrialYear) & TrialYear <= 2000),
            `Trials 2000 - Present` = sum(!is.na(TrialYear) & TrialYear > 2000)) %>%
  mutate(`First Trial` = ifelse(is.infinite(`First Trial`), NA, `First Trial`))

pro_table = uj_data %>% 
  group_by(`prosecuting.state`) %>% 
  summarise(`First Case` = min(`Case.Year`),
            `Total Cases` = sum(!is.na(Case.Year)),
            `Cases 1950 - 2000` = sum(!is.na(Case.Year) & Case.Year <= 2000),
            `Cases 2000 - Present` = sum(!is.na(Case.Year) & Case.Year > 2000),
            `First Trial` = suppressWarnings(min(`TrialYear`, na.rm=T)),
            `Total Trials` = sum(!(is.na(TrialYear))),
            `Trials 1950 - 2000` = sum(!is.na(TrialYear) & TrialYear <= 2000),
            `Trials 2000 - Present` = sum(!is.na(TrialYear) & TrialYear > 2000)) %>%
  mutate(`First Trial` = ifelse(is.infinite(`First Trial`), NA, `First Trial`))
```

# Merge UJ Dataset with CCode

```{r}
pro_table[pro_table$prosecuting.state == "United States", "prosecuting.state"] = "United States of America"
pro_table = inner_join(pro_table,ccode,by = c("prosecuting.state" = "StateNme"))

def_table[def_table$def.nationality.state == "United States", "def.nationality.state"] = "United States of America"
def_table = inner_join(def_table,ccode,by = c("def.nationality.state" = "StateNme"))
```

# Merge UJ Dataset with Replication Data

```{r}
pro_data = uj_data %>% group_by(prosecuting.state, Case.Year) %>%
  summarise(count = n())
def_data = uj_data %>% group_by(def.nationality.state, Case.Year) %>%
  summarise(count = n())

pro_data = inner_join(pro_data,ccode,by = c("prosecuting.state" = "StateNme"))
def_data = inner_join(def_data,ccode,by = c("def.nationality.state" = "StateNme"))

colnames(pro_data)[3] = "prosecuting.casecount"
colnames(def_data)[3] = "defending.casecount"

pro_data_trial = uj_data %>% group_by(prosecuting.state, TrialYear) %>% drop_na() %>%
  summarise(count = n())
def_data_trial = uj_data %>% group_by(def.nationality.state, TrialYear) %>% drop_na() %>%
  summarise(count = n())

pro_data_trial = inner_join(pro_data_trial,ccode,by = c("prosecuting.state" = "StateNme"))
def_data_trial = inner_join(def_data_trial,ccode,by = c("def.nationality.state" = "StateNme"))

colnames(pro_data_trial)[3] = "prosecuting.trialcount"
colnames(def_data_trial)[3] = "defending.trialcount"

merged_data = left_join(replication_data,pro_data[,c(2,3,4)],by = c("ccode2" = "CCode", "year" = "Case.Year"))
merged_data = left_join(merged_data,def_data[,c(2,3,4)],by = c("ccode1" = "CCode", "year" = "Case.Year"))

merged_data = left_join(merged_data,pro_data_trial[,c(2,3,4)],by = c("ccode2" = "CCode", "year" = "TrialYear"))
merged_data = left_join(merged_data,def_data_trial[,c(2,3,4)],by = c("ccode1" = "CCode", "year" = "TrialYear"))
```

# Merge Leblang Data with CCode

```{r}
ccode = read_excel("COW-ISO-IMF country code lists.xlsx")
ccode = distinct(ccode, CCode, .keep_all = T)
ccode = ccode[,c(2,4)]

leblang_data = inner_join(leblang_data,ccode,by = c("iso_o" = "ISO"))
colnames(leblang_data)[7] = "ccode1"

leblang_data = inner_join(leblang_data,ccode,by = c("iso_d" = "ISO"))
colnames(leblang_data)[8] = "ccode2"
```

# Merge Leblang Data (Leblang + Replication + UJ)

```{r}
merged_data = left_join(merged_data,leblang_data,by = c("ccode1" = "ccode1", "ccode2" = "ccode2", "year" = "year"))
```

# Rome Statute Data

```{r}
rome_data = read_xlsx("Data-Rome-Statute.xlsx")
rome_data = rome_data[,c(1,2,4)]
rome_data[rome_data$StateName == "United States", "StateName"] = "United States of America"
```

# Merge Rome Statute with CCode

```{r}
ccode = read_excel("COW-ISO-IMF country code lists.xlsx")
ccode = distinct(ccode, CCode, .keep_all = T)
ccode = ccode[,c(2,3)]

rome_data = inner_join(rome_data,ccode,by = c("StateName" = "StateNme"))
```

# Merge Rome Statute with Main Data

```{r}
merged_data = merged_data %>%  left_join(rome_data[,c(2:4)],by = c("ccode2" = "CCode"))
merged_data = merged_data %>% rowwise() %>% mutate(romesigned = ifelse(`Sign-Start` <= `year`, 1, 0))
merged_data = merged_data %>% rowwise() %>% mutate(romeratify = ifelse(`Ratify-Start` <= `year`, 1, 0))
```

# Merge Refugee with Main Data

```{r}
merged_data = merged_data %>%  left_join(unhcr_data,by = c("ccode1" = "origin_ccode", "ccode2" = "asylum_ccode", "year" = "year"))
```

# DPI data + Merge with CCode

```{r}
dpi_data = read.csv("DPI2017_basefile_Jan2018.csv")
dpi_data = dpi_data[,c("countryname","ifs","year","execrlc")]

ccode = read_excel("COW-ISO-IMF country code lists.xlsx")
ccode = distinct(ccode, CCode, .keep_all = T)
ccode = ccode[,c(2,4)]

dpi_data = inner_join(dpi_data,ccode,by = c("ifs" = "ISO"))
```

# Merge DPI with Main Data

```{r}
merged_data = merged_data %>%  left_join(dpi_data[,c(3,4,5)],by = c("ccode2" = "CCode", "year" = "year"))
```

# Add Logistic Variable for Cases and Trials for ALL CASES to receiving/sending by YEAR

```{r}
merged_data = merged_data %>% rowwise() %>% mutate(anydefendingcase = ifelse(`defending.casecount` > 0, 1, 0))
merged_data = merged_data %>% rowwise() %>% mutate(anyprosecutingcase = ifelse(`prosecuting.casecount` > 0, 1, 0))
merged_data = merged_data %>% rowwise() %>% mutate(anydefendingtrial = ifelse(`defending.trialcount` > 0, 1, 0))
merged_data = merged_data %>% rowwise() %>% mutate(anyprosecutingtrial = ifelse(`prosecuting.trialcount` > 0, 1, 0))
```

# Split Data by First Case/Trial for Relogit

```{r}
prosecuting_data = pro_table[,c(1,2,6,10)]
merged_data = merged_data %>%  left_join(prosecuting_data[,c(2:4)],by = c("ccode2" = "CCode"))
```

# Case/Trial/Investigations that Year (_nojd indicates Non John Doe tallies)

```{r}
ccode = read_excel("COW-ISO-IMF country code lists.xlsx")
ccode = distinct(ccode, CCode, .keep_all = T)
ccode = ccode[,c(2,3)]

uj_data = inner_join(uj_data,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(uj_data)[14] = "ccode1"
uj_data = inner_join(uj_data,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(uj_data)[15] = "ccode2"

case_dyad = uj_data[,c("Case.Year","ccode1","ccode2")]
trial_dyad = uj_data[,c("TrialYear","ccode1","ccode2")]
invest_dyad = uj_data[,c("InvestYear","ccode1","ccode2")]
colnames(case_dyad)[1] = "year"
colnames(trial_dyad)[1] = "year"
colnames(invest_dyad)[1] = "year"

case_dyad_nojd = uj_data[uj_data$isjd == 0,c("Case.Year","ccode1","ccode2")]
trial_dyad_nojd = uj_data[uj_data$isjd == 0,c("TrialYear","ccode1","ccode2")]
invest_dyad_nojd = uj_data[uj_data$isjd == 0,c("InvestYear","ccode1","ccode2")]
colnames(case_dyad_nojd)[1] = "year"
colnames(trial_dyad_nojd)[1] = "year"
colnames(invest_dyad_nojd)[1] = "year"

merged_data$index = 1:nrow(merged_data)
merged_data$anynewcase = 0
merged_data$anynewtrial = 0
merged_data$anynewinvest = 0
merged_data$anynewcase_nojd = 0
merged_data$anynewtrial_nojd = 0
merged_data$anynewinvest_nojd = 0

suppressMessages(library(plyr))
merged_data$anynewcase[match_df(merged_data,case_dyad)$index] = 1
merged_data$anynewtrial[match_df(merged_data,trial_dyad)$index] = 1
merged_data$anynewinvest[match_df(merged_data,invest_dyad)$index] = 1
merged_data$anynewcase_nojd[match_df(merged_data,case_dyad_nojd)$index] = 1
merged_data$anynewtrial_nojd[match_df(merged_data,trial_dyad_nojd)$index] = 1
merged_data$anynewinvest_nojd[match_df(merged_data,invest_dyad_nojd)$index] = 1

```

# NEW CASE COUNTS PER DYAD PER YEAR
```{r}
newcasecount = uj_data %>% group_by(prosecuting.state, def.nationality.state, Case.Year) %>%
  dplyr::summarise(count = n())

colnames(newcasecount)[4] = "newcasecount"
newcasecount = inner_join(newcasecount,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newcasecount)[5] = "ccode1"
newcasecount = inner_join(newcasecount,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newcasecount)[6] = "ccode2"

merged_data = left_join(merged_data,newcasecount[,c(3:6)], by = c("year" = "Case.Year", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

# NEW TRIAL COUNTS PER DYAD PER YEAR
```{r}
newtrialcount = uj_data %>% group_by(prosecuting.state, def.nationality.state, TrialYear) %>%
  dplyr::summarise(count = n())
newtrialcount = newtrialcount[!is.na(newtrialcount$TrialYear),]

colnames(newtrialcount)[4] = "newtrialcount"
newtrialcount = inner_join(newtrialcount,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newtrialcount)[5] = "ccode1"
newtrialcount = inner_join(newtrialcount,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newtrialcount)[6] = "ccode2"

merged_data = left_join(merged_data,newtrialcount[,c(3:6)], by = c("year" = "TrialYear", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

# NEW INVESTIGATION COUNTS PER DYAD PER YEAR
```{r}
newinvestcount = uj_data %>% group_by(prosecuting.state, def.nationality.state, InvestYear) %>%
  dplyr::summarise(count = n())
newinvestcount = newinvestcount[!is.na(newinvestcount$InvestYear),]

colnames(newinvestcount)[4] = "newinvestcount"
newinvestcount = inner_join(newinvestcount,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newinvestcount)[5] = "ccode1"
newinvestcount = inner_join(newinvestcount,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newinvestcount)[6] = "ccode2"

merged_data = left_join(merged_data,newinvestcount[,c(3:6)], by = c("year" = "InvestYear", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

# COUNT WITHOUT JOHN DOES
## CASES
```{r}
newcasecount_nojd = uj_data[uj_data$isjd == 0,] %>% group_by(prosecuting.state, def.nationality.state, Case.Year) %>%
  dplyr::summarise(count = n())

colnames(newcasecount_nojd)[4] = "newcasecount_nojd"
newcasecount_nojd = inner_join(newcasecount_nojd,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newcasecount_nojd)[5] = "ccode1"
newcasecount_nojd = inner_join(newcasecount_nojd,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newcasecount_nojd)[6] = "ccode2"

merged_data = left_join(merged_data,newcasecount_nojd[,c(3:6)], by = c("year" = "Case.Year", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

## TRIALS
```{r}
newtrialcount_nojd = uj_data[uj_data$isjd == 0,] %>% group_by(prosecuting.state, def.nationality.state, TrialYear) %>%
  dplyr::summarise(count = n())
newtrialcount_nojd = newtrialcount_nojd[!is.na(newtrialcount_nojd$TrialYear),]

colnames(newtrialcount_nojd)[4] = "newtrialcount_nojd"
newtrialcount_nojd = inner_join(newtrialcount_nojd,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newtrialcount_nojd)[5] = "ccode1"
newtrialcount_nojd = inner_join(newtrialcount_nojd,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newtrialcount_nojd)[6] = "ccode2"

merged_data = left_join(merged_data,newtrialcount_nojd[,c(3:6)], by = c("year" = "TrialYear", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

## INVESTIGATIONS

```{r}
newinvestcount_nojd = uj_data[uj_data$isjd == 0,] %>% group_by(prosecuting.state, def.nationality.state, InvestYear) %>%
  dplyr::summarise(count = n())
newinvestcount_nojd = newinvestcount_nojd[!is.na(newinvestcount_nojd$InvestYear),]

colnames(newinvestcount_nojd)[4] = "newinvestcount_nojd"
newinvestcount_nojd = inner_join(newinvestcount_nojd,ccode,by = c("def.nationality.state" = "StateNme"))
colnames(newinvestcount_nojd)[5] = "ccode1"
newinvestcount_nojd = inner_join(newinvestcount_nojd,ccode,by = c("prosecuting.state" = "StateNme"))
colnames(newinvestcount_nojd)[6] = "ccode2"

merged_data = left_join(merged_data,newinvestcount_nojd[,c(3:6)], by = c("year" = "InvestYear", "ccode1" = "ccode1", "ccode2" = "ccode2"))
```

# SWAP CCODE1 and CCODE2 COLUMN

```{r}
colnames(merged_data)[1:2] = c("ccode2","ccode1")
colnames(merged_data)[4:5] = c("country2","country1")
```

# CREATE CSV

```{r}
write.csv(merged_data,"Full Dataframe.csv") 
```

